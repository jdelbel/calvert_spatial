---
title: "R Notebook"
output: html_notebook
---



```{r}
#Upload packages
library(tidyverse)
library(readxl)
library(here)
library(vegan)
library(factoextra)
library(ggdendro)
```

```{r}
#Upload data
#Upload output from OBIS taxonomy matching/formatting
micro <- read_csv(here("files", "calvert.csv"))
```

```{r}
#Selecting columns
micro_clust <- micro %>% 
  select(date, site_id, scientificName, count)

#Complete species list for each station date and fill with zero for not observed. Because I have some species separated out with identificationRemarks, identificationQualifiers and different resting stages, I sum these. I need to decide on best method for this once I have the analysis zeroed in. Complete gives me empty rows... might not need to do this...
micro_clust <- micro_clust %>%  
  #complete(date, site_id, scientificName, fill = list(count = 0)) %>%  
  group_by(date, site_id, scientificName) %>% 
  summarize(species_sum = sum(count)) %>% 
  ungroup()

#Combining date and siteID - can't have both for the clustering I am trying now
micro_clust <- micro_clust %>% 
  unite(date_site, date, site_id, sep = "_")

#pivoting longer so species are columns. 
micro_clust <- micro_clust %>% 
  pivot_wider(names_from = scientificName, values_from = species_sum) %>% 
  column_to_rownames(var = "date_site") %>% 
  mutate_all(~replace(., is.na(.), 0))
```

```{r}
#Working through steps from https://www.datanovia.com/en/blog/cluster-analysis-in-r-simplified-and-enhanced/

#Calculate dissimilarity matrix. 
bray.dist <- vegdist(log10(micro_clust+1), "bray")

#Compute hierarchical clustering - not sure if this is the right way to do this...
bray.hc <- hclust(bray.dist, method = "average")

test <- plot(bray.hc, cex = 0.5, hang = -1)

ggsave(here("figures", "bray_average_test_2.png"), test, width=16, height=15, dpi=300)
```
```{r}
ggdendrogram(bray.hc, size = 5)

ggsave(here("figures", "bray_average_test_2.png"), width=16, height=15, dpi=300)

#Well I have a dendrogram - But does it mean anything? I feel like I'm trying to look at two different questions. Spatial and Temporal...

```



```{r}
#Trying different plotting methods?
fviz_dend(bray.hc, rect = TRUE) # dendrogam
```






```{r}
#Goal - similarity/dissimilarity cluster analysis 

#How differnt or similar are the three calvert island sites

#Distance metric - Bray-curtis is used for abundance data

#Linkage method - criterion that will determine how observations will be grouped together.

#Figtree (software) allows you to view and edit dendograms - look into this

#https://ourcodingclub.github.io/tutorials/data-clustering/

#Mahara - average linkage Bray-curtis dissimilarity, log10(x+1) transformed

# https://www.davidzeleny.net/anadat-r/doku.php/en:similarity

# similarity calculated using similarity indices ranging from 0 to 1. Ordination uses distances (Euclidean). Legendre & Legendre (2012) offers key on how to select appropriate measure for given data. bray-Curtis and Hellinger distances may be better than Euclidean.

# Symmetrical indices (thos which consider double 0s as relevant not useful for ecological data). Asymmetrical similarity indices (ignore double zeros). Two types, qualitative (presence/absence) and quantitative (raw or transformed species abundance). 

#Qualitative (binary) asymmetrical similarity indices. Information about number of species shared by both samples AND number of species occuring in first or second sampe only.

#Quantitative similarity indices. Percentage Similarity and includes Bray-Curtis

#Distance Indices. Similarity indices return highest value when both samples the same. Distance indices opposite. Two types: 1) Those calculated from similarity indices (includes Bray-Curtis) and; 2) Those which have no analogue in similarity indices. Important criterium is whether distance index is metric or not. Metric = minimum distance is 0, distance is always positive, distance between sample 1 and 2 same as 2 and has triangle inequality.

#Bray-Curits/percentage difference. Suitable for community composition data since it is asymmetrical (ignores double 0s) and meaningful upper vlaue equal to 1. Considers absolute species abundances

```







