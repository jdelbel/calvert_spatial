---
title: "R Notebook"
output: html_notebook
---

```{r}
#Upload packages
library(tidyverse)
library(readxl)
library(here)
library(factoextra)
library(ggdendro)
library(dendextend)
library(colormap)
library(indicspecies)
library(fuzzySim)
library(cluster)
library(patchwork)
library(vegan)
library(RColorBrewer)
library(ggcorrplot) 
# library(clustsig)

```

```{r}
#Upload data

#Upload microscopy abundance data in OBIS and long/tide format
chem <- read_csv(here("files", "chemtax_2023-04-14.csv")) 

#Upload physical-chemical clusters derived via PCA
clust_pca <- read_csv(here("outputs", "pca_clusters_2023-02-01.csv"))

bio_clust <- read_csv(here("outputs", "bio_clust.csv"))
```

```{r}

#Adding location instead of site ID for interpretation of results
chem <- chem %>% 
    mutate(location = case_when(site_id == "DFO2" ~ "F",
                              site_id == "KC10" ~ "C",
                              site_id == "QCS01" ~ "S",
                              TRUE ~ as.character(site_id))) %>% 
  relocate(location, .after = site_id)

#Creating a unique location-date ID for each sample - makes labels for plotting by dendrogram more informative 
chem <- chem %>% 
  unite(sample_name, c(location, date), sep = "", remove = FALSE)

chem <- chem %>% 
  rename(cyan = Cyanobacteria, hapt = Hapto, GA = `Prasinophytes-3`,
         cryp = Cryptophytes, dino = `Dinoflagellates-1`, dict = Dictyo, 
         raph = Raphido,
         diat = `Diatoms-1`)

#Renaming the sample_name unique ID in the cluster datasheet so that it can be joined to the microscoply data
clust_pca <- clust_pca %>%
  rename(sample_name = label)

#Joining the PCA clusters to the microscopy data
chem <- chem %>%
  left_join(clust_pca) %>%
  rename(clust_pca = cluster) %>%
  relocate(clust_pca, .after = location)

```

```{r}
#Here, only including 2019-2020
chem <- chem %>% 
  filter(date < "2021-01-01")
```

```{r}
#I think for the site wide comparison, I need to only have months where data were collected at all stations.
#QCS01 - 2019-08-31
#KC10 - 2020-04-30

#Determining total number of samples - 50.
sample_num <- chem %>% 
  distinct(date, site_id)

sample_num <-  sample_num %>% 
  mutate(year = lubridate::year(date),
         month = lubridate::month(date))

sample_num <- sample_num %>% 
  mutate(month_surv = case_when(
                                date == "2020-04-30" ~ 5,
                                date == "2019-08-31" ~ 9,
                                date == "2020-11-27" ~ 12,
                                TRUE ~ as.numeric (month)))

sample_num_s <- sample_num %>% 
  filter(site_id == "QCS01") %>% 
  select(date_s = date, year, month_surv)

sample_num_c <- sample_num %>% 
  filter(site_id == "KC10") %>% 
  select(date_c = date, year, month_surv)

sample_num_f <- sample_num %>% 
  filter(site_id == "DFO2") %>% 
  select(date_f = date, year, month_surv)

sample_compare <- sample_num_s %>% 
  left_join(sample_num_c) %>% 
  left_join(sample_num_f)

shelf_list <- sample_compare$date_s
channel_list <- sample_compare$date_c
fjord_list <- sample_compare$date_f

#This sample is troublesome
# test <- micro %>% 
#   filter(date == "2020-11-04")

#Or I just scrap that plot and use a similar one to Du et al.

#What about trying hierarchical clustering again - done this so many freaking times, but could try again with all data included.
```

```{r}
#Subsetting data to only have matching stations
chem <- chem %>% 
  filter(date %in% shelf_list |
           date %in% channel_list |
           date %in% fjord_list)
```

```{r}
#Adding year and month to the microscopy dataset for analysis.

chem <- chem %>% 
  mutate(year = lubridate::year(date),
         month = lubridate::month(date)) %>% 
  relocate(year, .after = date) %>% 
  relocate(month, .after = year)
```

```{r}
#Pulling out species counts for transformation and use in analysis
species <- chem[, 8:ncol(chem)]

#Transforming the abundance data
t_abund <- species
# t_abund <- decostand(species, "total")

```

```{r}
#Making separate sheets to performed clustering on.
hc_abund <- t_abund

#Creating a list of rownames to attach to the clustering sheets - allows me to plot on the dendrogram.
labs_list <- chem$sample_name

#Making the rownames of the clustering matrix the ones specified in the above list.
rownames(hc_abund) <- labs_list

```

```{r}
#method to assess
m <- c("average", "single","complete","ward")
names(m) <- c("average", "single","complete","ward")

#function to compute coefficient
ac <- function(x){agnes(hc_abund, method = x)$ac}
map_dbl(m,ac)
```

```{r}
#Performing hierarchical clustering

#Calculating Bray-Curtis Distances
dis_abund <- vegdist(hc_abund, method = "bray")


#Applying wards linkage method
# clust_ward_abund <- agnes(dis_abund, method = "ward")
clust_ward_abund <- hclust(dis_abund, method = "complete")


```

```{r}
coph <- cophenetic(clust_ward_abund)
cor(dis_abund, coph) 
```
```{r}
# Enhanced hierarchical clustering, cut in 3 groups
fviz_dend(clust_ward_abund, cex = 0.5, h = 0.65, color_labels_by_k = TRUE)
```

```{r}
#For the abundance data, looking at some methods to determine the number of clusters

#These are time intensive, so turning off until needed

fviz_nbclust(hc_abund, FUN = hcut, method = "wss")
fviz_nbclust(hc_abund, FUN = hcut, method = "silhouette")
gap_stat <- clusGap(hc_abund, FUN = hcut, nstart = 25, K.max = 10, B = 50)
fviz_gap_stat(gap_stat)

#In general, these approaches do not show many clusters - only 2. This bothers me as there is clearly more structure in the data.
```


```{r}
#Trying cutting at line 

# Abundance data
k_abund <- 0.65
clust_abund <- cutree(clust_ward_abund, h = k_abund)
#
clust_df_abund <- data.frame(label = rownames(hc_abund),
                                   cluster = factor(clust_abund))
```


```{r}
# extract dendrogram segment data for plotting

#Abundance data
dend_abund <- as.dendrogram(clust_ward_abund)
dendrogram_data_abund <- dendro_data(dend_abund)
dendrogram_segments_abund <- dendrogram_data_abund$segments 

```

```{r}
#Setting up sheets so that I can color labels by station

#Creating metadata sheet with 
metadata <- chem %>%
  select(sample_name, site_id)

# get terminal dendrogram segments and join with names. - abundance data.
dendrogram_ends_abund <- dendrogram_segments_abund %>%
 filter(yend == 0) %>% 
 left_join(dendrogram_data_abund$labels, by = "x") %>% 
 rename(sample_name = label) %>% 
 left_join(metadata, by = "sample_name") 

```

```{r}
#This is used to draw cluster boxes around the dendrogram clusters in the plot. 


#Abundance
dendrogram_data_abund[["labels"]] <- merge(dendrogram_data_abund[["labels"]], clust_df_abund, by = "label")
rect_abund <- aggregate(x~cluster, label(dendrogram_data_abund), range)
rect_abund <- data.frame(rect_abund$cluster, rect_abund$x)
ymax_abund <- mean(clust_ward_abund$height[length(clust_ward_abund$height) - ((k_abund-2):(k_abund-1))])

```


```{r}
#I'm not 100% sure how this all works, but it does - sets up colors for the sites for plotting with dendrogram.

#Here doing abundance data

# Generate custom color palette for dendrogram ends based on metadata variable - Site
unique_vars_abund <- levels(factor(dendrogram_ends_abund$site_id)) %>% 
  as.data.frame() %>% 
  rownames_to_column("row_id")

# count number of unique variables
color_count_abund <- length(unique(unique_vars_abund$.))

# get RColorBrewer palette
get_palette_abund <- colorRampPalette(brewer.pal(n = 3, name = "Set1"))

# produce RColorBrewer palette based on number of unique variables in metadata:
palette_abund <- get_palette_abund(color_count_abund) %>% 
 as.data.frame() %>%
 rename("color" = ".") %>%
 rownames_to_column(var = "row_id")

color_list_abund <- left_join(unique_vars_abund, palette_abund, by = "row_id") %>%
 select(-row_id)

site_color_abund <- as.character(color_list_abund$color)
names(site_color_abund) <- color_list_abund$.
```

```{r}
clust_df_abund2 <- clust_df_abund %>% 
  rename(sample_name = label)

dendrogram_ends_abund <- dendrogram_ends_abund %>% 
  left_join(clust_df_abund2)
```

```{r}
#Plotting dendrogram - saving for incorporation later.
ggplot() +
 geom_segment(data = dendrogram_segments_abund, 
              aes(x = x, y = y, xend = xend, yend = yend)) +
 geom_segment(data = dendrogram_ends_abund, aes(x = x, y = y.x, xend = xend,
                                          yend = yend, color = as.factor(cluster),
              size = 2)) +
 geom_text(data = dendrogram_ends_abund, aes(x = x, y = y.y, label = sample_name,
                                       color = as.factor(cluster),
           hjust = 1, angle = 90, size = 6)) +
  geom_hline(yintercept = 0.65) +
 # geom_rect(data = rect_abund, aes(xmin = X1 - .3, xmax = X2 + .3, ymin = 0,
 #                                  ymax = ymax_abund),
 #            color = "black", fill = NA, size = 0.8) +
 # scale_color_manual(values = site_color_abund) +
 # scale_y_reverse(limits = c(1, -0.5)) +
 ylim(-0.4, 1) +
  # coord_flip() +
 theme_bw() +
 theme(legend.position = "none",
       axis.title.x = element_blank(),
       axis.title.y = element_blank(),
       # axis.text.y = element_blank(),
       text = element_text(size = 30),
       axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
 ylab("Distance") # flipped x and y coordinates for aesthetic reasons

 
ggsave(here("figures_nmds_new", "chemtax_2023-04-14.png"),
       width = 16, height = 12, dpi = 300)
```











```{r}
#Setting up the derived abundance clusters for joining with the actual data
clust_abund_join <- clust_df_abund %>% 
  select(sample_name = label, clust_abund = cluster)

chem <- chem %>%
  left_join(clust_abund_join) %>%
  relocate(clust_abund, .after = clust_pca)
  
```

```{r}
#ANOSIM test to see if groupings statistically significant 
# clust_pca <- chem$clust_pca
clust_abund <- chem$clust_abund



# ano_clust_pca = anosim(t_abund, clust_pca, distance = "bray", permutations = 9999)
# ano_clust_pca
#  
ano_clust_abund = anosim(t_abund, clust_abund, distance = "bray", permutations = 9999)
ano_clust_abund
# # #  
# ano_clust_rel = anosim(t_rel, clust_rel, distance = "bray", permutations = 9999)
# ano_clust_rel
#  
# ano_clust_pca_rel = anosim(t_rel, clust_pca, distance = "bray", permutations = 9999)
# ano_clust_pca_rel

```



```{r}
set.seed(123)

#Running nmds all species
nmds_abund <-  metaMDS(t_abund, distance = "bray", autotransform = F, 
                         k = 2, trymax = 100) 

#Show results including stress 
nmds_abund

#Checking stressplot for fit
stressplot(nmds_abund)

```


```{r}
#Pulling NMDS scores, months and stations for plotting NMDS is ggplot

#All abundance
data.scores_abund = as.data.frame(scores(nmds_abund))
data.scores_abund$month = chem$month
data.scores_abund$site = chem$location
data.scores_abund$year = chem$year
data.scores_abund$clust_pca = chem$clust_pca
data.scores_abund$clust_abund = chem$clust_abund

```

```{r}
#Order locations from fjord to shelf for plotting order
order_loc <- c("F", "C", "S")

#Setting location order for plots 
data.scores_abund <- arrange(mutate(data.scores_abund,
                         site = factor(site, levels = order_loc)))

```


```{r}
# #Looking at species scores to add to the nmds plot
# 
#All species
vf <- envfit(nmds_abund, t_abund, perm = 999)
# 
# #Diatoms
# vf_diat <- envfit(nmds_diat, transform_diat, perm = 999)
# 
# #Dinoflagellates
# vf_dino <- envfit(nmds_dino, transform_dino, perm = 999)
# 
#Pulling out r2 scores
#All species
r2 <- vf$vectors$r
# 
# #Diatoms
# r2_diat <- vf_diat$vectors$r
# 
# #Diatoms
# r2_dino <- vf_dino$vectors$r
# 
#MAking dataframe out of r2 values
#All species
r2_df <- as.data.frame(r2)
# 
# #Diatoms
# r2_df_diat <- as.data.frame(r2_diat)
# 
# #Dino
# r2_df_dino <- as.data.frame(r2_dino)
# 
# #Pulling and binding vectors and r2 scores
# #All species
spp.scrs <- as.data.frame(scores(vf, display = "vectors"))
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs))
spp.scrs2 <- cbind(spp.scrs, r2_df)
```


```{r}
#Pulling species with only r2 > 0.3 scores
#All species
spp.scrs2 <- spp.scrs2 %>%
  filter(r2 >= 0.20)
# 
# #Diatoms
# spp.scrs2_diat <- spp.scrs2_diat %>%
#   filter(r2_diat >= 0.30)
# 
# #Dinoflagellates
# spp.scrs2_dino <- spp.scrs2_dino %>%
#   filter(r2_dino >= 0.30)
```


```{r}
#Making shorter abbreviated species names for plotting

# rownames(spp.scrs2) <- c("Hill.",
#                          "Tel.",
#                          "S.mar.",
#                          "P.pou.",
#                          "C.soc.",
#                          "C.cin.") 
# 
# rownames(spp.scrs2_diat) <- c("C.clo.",
#                               "P.n.s.",
#                               "R.set.",
#                               "Pen.",
#                               "S.mar.",
#                               "Bid.",
#                               "L.dan.")
# 
# rownames(spp.scrs2_dino) <- c("Gymn.",
#                               "Gyro.",
#                               "Kato.",
#                               "S.pre.",
#                               "S.tro.")
#                               
```

```{r}
#This is the horizontal version of the month and year nMDS panel shown incorporated into a large panel later 

ggplot(data = data.scores_abund, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(data = data.scores_abund, aes(fill = as.factor(month), shape = site),
             size = 7, stroke = 1.5) + 
  scale_fill_brewer(palette = "Spectral") +
  # scale_fill_manual(values = c("blue", "springgreen4", "black", "magenta")) + 
  scale_shape_manual(values = c(21, 22, 23 ,24)) + 
  geom_segment(data = spp.scrs2,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "grey",
               size = 1.2, alpha = 0.7) +
  # geom_text(data = spp.scrs2, aes(x = NMDS1, y = NMDS2), colour = "black",
  #            fontface = "bold", label = row.names(spp.scrs2), size = 7) +
  ggrepel::geom_text_repel(data = spp.scrs2, aes(x = NMDS1, y = NMDS2,
                                           label = row.names(spp.scrs2)),
                  # box.padding = unit(0.5, 'lines'),
                  # point.padding = NA,
                  point.padding = unit(2, 'lines'),
                  segment.color = 'black',
                  segment.size = 0.5,
                  segment.alpha = 0.7,
                  arrow = arrow(length = unit(0.01, 'npc')),
                  # nudge_y = 0.2,
                  # nudge_x = -0.2,
                  force = 3,
                  max.iter = 3e3,
                  size = 7) +
  # xlim(-0.4, 0.7) +
  # annotate("text", x = 0.60, y = 0.40, label = "a)", size = 10) +
  # annotate("text", x = 0.40, y = -0.40, label = "Stress = 0.23", size = 10) +
  theme(axis.title = element_text(size = 25, face = "bold", colour = "black"),
        panel.background = element_blank(),
        panel.border = element_rect(fill = NA, colour = "black"), 
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        # axis.title.x = element_blank(),
        # axis.title.y = element_blank(),
        # legend.position = "none",
        text = element_text(size = 32)) +
  labs(fill = "Month", shape = "Station") +
  guides(fill = guide_legend(override.aes = list(shape = 21)))

ggsave(here("figures_nmds_new", "chem_2023-04-14.png"),
       width = 8, height = 5, dpi = 300)
```

```{r}
#Indicator species analysis
# https://jkzorz.github.io/2019/07/02/Indicator-species-analysis.html

#Indicators by station for diatoms
inv_clust_abund = multipatt(t_abund, clust_abund, func = "r.g", duleg = F,
                       control = how(nperm = 999))

#Looking at results of analysis
summary(inv_clust_abund)

iv <- labdsv::indval(t_abund, clust_abund)

summary(iv)
```


```{r}

# inv_clust_abund_sp <- data.table::as.data.table(inv_clust_abund$sign, keep.rownames = TRUE)
# 
# inv_clust_abund_sp <- inv_clust_abund_sp %>%
#   filter(s.1 == 1 | s.2 == 1 | s.3 == 1 | s.4) %>%
#   filter(p.value < 0.05) %>%
#   # filter(!rn == "Skeletonema marinoi") %>%
#   arrange(rn)
# 
# inv_clust_rel_sp_list <- inv_clust_rel_sp$rn
# 
# inv_clust_rel_sp_list

```

```{r}
chem <- chem %>%
  mutate(month = lubridate::month(date)) %>% 
  mutate(season = case_when(month == 12 | month == 1 | month == 2 ~ "W",
                            month >= 3 & month <= 5 ~ "Sp",
                            month >= 6 & month <= 8 ~ "S",
                            month >= 9 & month <= 12 ~ "A",)) %>%
  relocate(season, .after = month)    
  
#I want to push December from each year to winter of the next year
chem <- chem %>%
  mutate(year = case_when(season == "winter" & month == 12 ~ year+1,
                           TRUE ~ as.numeric(year)))
```

```{r}
chem_long <- chem %>% 
  pivot_longer(c(cyan:diat), names_to = "group", values_to = "tchla") %>% 
  left_join(bio_clust)
```


```{r}
#Ordering the data in the order of the dendrogram from hierarchical clustering.

#Creating a list with the order of the samples in the dendrogram.
hc_order <- dendrogram_ends_abund$sample_name

hc_order_exp <- as_tibble(hc_order)

#Setting the order to the same as the clustering using the specified list
chem_long$sample_name <- factor(chem_long$sample_name, levels = unique(hc_order))

#Order locations from fjord to shelf
order_loc <- c("F", "C", "S")

#Chemtax - Specify order of phyto groups for figures
chem_long <- arrange(mutate(chem_long,
                         location = factor(location, levels = order_loc)))

#Order locations from fjord to shelf
order_loc_seas <- c("W", "Sp", "S", "A")

#Chemtax - Specify order of phyto groups for figures
chem_long <- arrange(mutate(chem_long,
                         season = factor(season, levels = order_loc_seas)))
```

```{r}
#Setting plotting order phytoplankton groups

#Order phytoplankton groups roughly from smallest to largest - create order list
order_chem <- c("cyan", "hapt", "GA", "cryp",
                   "dino", "raph", "dict", "diat")

#Chemtax spring bloom - Specify order of phyto groups for figures
chem_long <- arrange(mutate(chem_long,
                                group = factor(group,
                                levels = order_chem)))

```

```{r}
#Set Color palette for plotting. Currently based on QU39 manuscript. Brewer has some good ones for R style.
palette <- c("#ff8000", #1 - Diatoms (orange)
             "#ff99c7", #2 - Dictyochophytes (pink)
             "#4d6600", #3 - Raphidophytes (dark green)
             "#ff0000", #4 - Dinoflagellates (Red)
             "#ffff00", #5 - Cryptophytes (yellow)
             "#00ff00", #6 - Chlorophyta (light green)
             "#7d4dcc", #7 - Haptophytes (purple)
             "#000000") #8 - Cyanobacteria (black)
```


```{r}
# cp <- 
  
chem_long %>%  
  ggplot() + 
  geom_bar(aes(x = sample_name, y = tchla, 
           fill = fct_rev(group)), stat = "identity", position = "stack",
           color = "black") +
  scale_fill_manual(values = palette,
                    labels = c("Diat", "Dict", "Raph", "Dino", "Cryt", "Chlo", 
                               "Hapt", "Cyan")) +
  ylim(0, 12.5) +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text = element_text(colour = "black"),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank()) +
        # strip.background.y = element_blank(),
        # strip.text.y = element_blank()) +
  guides(fill = guide_legend(ncol = 4),
         color = "none")

# ggsave(here("figures_nmds_new", "AAA_clust_panel2_ds_65.png"), cp,
#        width = 16, height = 8, dpi = 300)
```

```{r}
chem_long %>%  
  ggplot() + 
  geom_bar(aes(y = sample_name, x = tchla, 
           fill = fct_rev(group)), stat = "identity", position = "stack",
           color = "black", width = 1) +
  facet_grid(clust_abund ~ ., scales = "free_y", space = "free") +
  # annotate("rect", xmin = 7.5, xmax = 13.5, ymin = 0, ymax = 34,
  #          color = "black", fill = "blue", alpha = .1) +
  # annotate("text", x = 10.5, y = 33, size = 5, label = "1") +
  # annotate("rect", xmin = 34.5, xmax = 46.5, ymin = 0, ymax = 34,
  #          color = "black", fill = "red", alpha = .1) +
  # annotate("text", x = 41, y = 33, size = 5, label = "2") +
  # annotate("rect", xmin = 3.5, xmax = 7.5, ymin = 0, ymax = 34,
  #          color = "black", fill = "green", alpha = .1) +
  # annotate("text", x = 5.5, y = 33, size = 5, label = "3") +
  # annotate("rect", xmin = 47.5, xmax = 78.5, ymin = 0, ymax = 34,
  #          color = "black", fill = "purple", alpha = .1) +
  # annotate("text", x = 65, y = 33, size = 5, label = "4") +
  # annotate("rect", xmin = 16.5, xmax = 33.5, ymin = 0, ymax = 34,
  #          color = "black", fill = "cyan", alpha = .1) +
  # annotate("text", x = 25, y = 33, size = 5, label = "5") +
  # annotate("text", x = 34, y = 33, size = 5, label = "6") +
  # annotate("rect", xmin = 1.5, xmax = 3.5, ymin = 0, ymax = 34,
  #          color = "black", fill = "pink", alpha = .1) +
  # annotate("text", x = 2.5, y = 33, size = 5, label = "7") +
  # annotate("text", x = 47, y = 33, size = 5, label = "8") +
  # annotate("text", x = 14, y = 33, size = 5, label = "9") +
  # annotate("text", x = 1, y = 33, size = 5, label = "10") +
  # annotate("text", x = 15, y = 32, size = 5, label = "11") +
  # annotate("text", x = 16, y = 31, size = 5, label = "12") +
  # scale_fill_manual(values = getPalette_c(colourCount_c)) +
  # ylim(0, 34) +
  scale_fill_manual(values = palette,
                    labels = c("Diat", "Dict", "Raph", "Dino", "Cryt", "Chlo", 
                               "Hapt", "Cyan")) +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text = element_text(colour = "black"),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank()) +
        # strip.background.y = element_blank(),
        # strip.text.y = element_blank()) +
  guides(fill = guide_legend(ncol = 4),
         color = "none")

ggsave(here("figures_nmds_new", "chem_60_vert.png"),
       width = 14, height = 16, dpi = 300)
```

```{r}
s_num <- chem_long %>% 
  distinct(sample_name, clust_abund, .keep_all = T) %>% 
  group_by(clust_abund) %>% 
  summarise(n = n()) %>% 
  ungroup()  

chem_long2 <- chem_long %>% 
  group_by(clust_abund, group) %>% 
  summarise(sum = mean(tchla)) %>% 
  ungroup() %>% 
  group_by(clust_abund) %>% 
  mutate(sum_tot = sum(sum)) %>% 
  ungroup()

chem_long2 <- chem_long2 %>% 
  left_join(s_num)

s_num_txt <- chem_long2 %>% 
  distinct(clust_abund, sum_tot, n)
```




```{r}
f1 <- ggplot() +
  geom_col(data = chem_long2, 
           aes(x = as.factor(clust_abund), y = sum, 
           fill = fct_rev(group)), position = "stack",
           color = "black") +
  geom_text(data = s_num_txt,
            aes(x = as.factor(clust_abund), y = sum_tot, label = n),
            vjust = -1, size = 5) +
  ylim(0, 15) +
  scale_fill_manual(values = palette,
                    labels = c("Diat", "Dict", "Raph", "Dino", "Cryt", "Chlo", 
                               "Hapt", "Cyan")) +
  labs(x = "Cluster",
       y = "TChla)") +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.text = element_text(colour = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank()) +
  guides(fill = guide_legend(ncol = 2),
         color = "none") 

f2 <- chem %>% 
  ggplot(aes(x = as.factor(clust_abund), fill = as.factor(season))) +
  geom_bar(position = "stack", color = "black", alpha = 0.8) +
  scale_fill_manual(values = c("darkolivegreen", "red2", "goldenrod1")) + 
  labs(y = "# of samples",
       x = "Cluster",
       fill = "Season") +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.text = element_text(colour = "black"),
        legend.position = c(0.85, 0.72),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

f3 <- chem %>% 
  ggplot(aes(x = as.factor(clust_abund), fill = as.factor(year))) +
  geom_bar(position = "stack", color = "black", alpha = 0.8) +
  scale_fill_manual(values = c("#d95f02", "#7570b3")) + 
  labs(y = "# of samples",
       x = "Cluster",
       fill = "Year") +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.text = element_text(colour = "black"),
        legend.position = c(0.85, 0.75),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

f4 <- chem %>% 
  ggplot(aes(x = as.factor(clust_abund), fill = as.factor(site_id))) +
  geom_bar(position = "stack", color = "black", alpha = 0.8) +
  scale_fill_manual(values = c("brown", "forestgreen", "royalblue4")) + 
  labs(y = "# of samples",
       x = "Cluster",
       fill = "Station") +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.text = element_text(colour = "black"),
        legend.position = c(0.85, 0.75),
        axis.title.x = element_blank())

fig <- f1 / f2 / f3 / f4

ggsave(here("figures_nmds_new", "chem_60.png"), fig,
        width = 8, height = 16, dpi = 300)
```
```{r}



ggplot() +
  geom_col(data = chem_long2, 
           aes(x = as.factor(clust_abund), y = sum, 
           fill = fct_rev(group)), position = "stack",
           color = "black") +
  geom_text(data = s_num_txt,
            aes(x = as.factor(clust_abund), y = sum_tot, label = n),
            vjust = -1, size = 5) +
  ylim(0, 15) +
  scale_fill_manual(values = palette,
                    labels = c("Diat", "Dict", "Raph", "Dino", "Cryt", "Chlo", 
                               "Hapt", "Cyan")) +
  labs(x = "Cluster",
       y = "TChla)") +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.text = element_text(colour = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank()) +
  guides(fill = guide_legend(ncol = 2),
         color = "none") 
```

```{r}


s_num_tax <- chem_long %>% 
  distinct(sample_name, cluster, .keep_all = T) %>% 
  group_by(cluster) %>% 
  summarise(n = n()) %>% 
  ungroup()  

chem_long_tax <- chem_long %>% 
  group_by(cluster, group) %>% 
  summarise(sum = mean(tchla)) %>% 
  ungroup() %>% 
  group_by(cluster) %>% 
  mutate(sum_tot = sum(sum)) %>% 
  ungroup()

chem_long_tax <- chem_long_tax %>% 
  left_join(s_num_tax)

s_num_txt_tax <- chem_long_tax %>% 
  distinct(cluster, sum_tot, n)


```

```{r}
ggplot() +
  geom_col(data = chem_long_tax, 
           aes(x = as.factor(cluster), y = sum, 
           fill = fct_rev(group)), position = "stack",
           color = "black") +
  geom_text(data = s_num_txt_tax,
            aes(x = as.factor(cluster), y = sum_tot, label = n),
            vjust = -1, size = 5) +
  ylim(0, 15) +
  scale_fill_manual(values = palette,
                    labels = c("Diat", "Dict", "Raph", "Dino", "Cryt", "Chlo", 
                               "Hapt", "Cyan")) +
  labs(x = "Cluster",
       y = "TChla)") +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.text = element_text(colour = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank()) +
  guides(fill = guide_legend(ncol = 2),
         color = "none") 
```
```{r}
chem_long %>%   
  mutate(year = lubridate::year(date)) %>% 
  ggplot() + 
  geom_area(aes(x = date, y = tchla, 
           fill = fct_rev(group)), stat = "identity", position = "stack",
           color = "black") +
  scale_fill_manual(values = palette,
                    labels = c("Diat", "Dict", "Raph", "Dino", "Cryt", "Chlo", 
                               "Hapt", "Cyan")) +
  facet_grid(location ~ year) +
  theme_bw() +
  theme(text = element_text(size = 25),
        axis.title.x = element_blank(),
        # axis.text.y = element_blank(),
        axis.text = element_text(colour = "black"),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        strip.background.y = element_blank(),
        strip.text.y = element_blank()) +
  guides(fill = guide_legend(nrow = 2),
         color = "none")
```


# ```{r}
# #I want to export these clusters to look at physio - Chemical.
# 
# plot_meta_export <- plot_meta %>% 
#   left_join(clust_df_abund2)
# 
# write_csv(plot_meta_export, here("outputs", "bio_clust.csv"))
# ```




Ok, I like this. 

1 - add number of samples for each cluster. (Done)
2 - Change the color map to the same as for the time-series plot. (Done)
3 - Add bars with year, station and season for each cluster. (Done)
4 - Maybe try shannon/richness? (maybe or just write in text?)
5 - Maybe add nmds? (Don't think it adds much) 
6 - try the same for the PCA clusters (Yeah, true)
7 - Add these cluster colors to the RDA (Do today)
8 - Make time-series plots with CHEMTAX for each station - maybe get them all on one plot. (Work on now.)

9 - ANOSIM table on different groupings.

Wham bam, I think that will be the manuscript



























